import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || ''
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || ''

// Criar cliente com configura√ß√µes de retry e timeout
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true
  },
  global: {
    headers: {
      'x-client-info': 'ddplanner-web'
    }
  }
})

// Fun√ß√£o helper para verificar se o Supabase est√° configurado
export const isSupabaseConfigured = () => {
  return !!(supabaseUrl && supabaseAnonKey && supabaseUrl !== '' && supabaseAnonKey !== '')
}

// Fun√ß√£o helper para executar opera√ß√µes do Supabase com tratamento de erro
export const executeSupabaseOperation = async <T>(
  operation: () => Promise<T>,
  fallback?: () => T,
  operationName = 'Opera√ß√£o Supabase'
): Promise<T | null> => {
  if (!isSupabaseConfigured()) {
    console.log(`‚ö†Ô∏è [SUPABASE] ${operationName}: Supabase n√£o configurado, usando fallback`)
    return fallback ? fallback() : null
  }

  try {
    const result = await operation()
    return result
  } catch (error: any) {
    // Verificar se √© erro de rede espec√≠fico
    if (error?.message?.includes('Failed to fetch') || 
        error?.message?.includes('Network Error') ||
        error?.message?.includes('fetch is not defined') ||
        error?.code === 'NETWORK_ERROR') {
      console.log(`üåê [SUPABASE] ${operationName}: Erro de rede detectado, usando fallback`)
      return fallback ? fallback() : null
    }

    // Para outros erros, logar mas n√£o quebrar a aplica√ß√£o
    console.error(`‚ùå [SUPABASE] ${operationName}: Erro n√£o relacionado √† rede:`, error)
    return fallback ? fallback() : null
  }
}